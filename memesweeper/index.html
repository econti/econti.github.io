<!DOCTYPE html>
<html>
<head>
  <style>
    body{
      margin:0;
    }
  </style>
  <script>
    window.onload = function(){
      var canvas = document.getElementById("gCanvas");
      c = canvas.getContext("2d");
      timer();
      init();
    }
    //global vars
    var c; //canvas
    var box; //normal tile
    var flag;
    var zero; //tile with no surrounding bombs
    var numBombs = 10; //number of bombs
    var bombs = []; //array of bomb locations 
    var clickedBoxes = []; //array of clicked boxes
    var locations = [];

    var settings = {
      rows: 10,
      cols: 10,
      width: 30,
      height: 30
    };

    function init(){
      box = new Image();
      box.src = "assets/box.png"
      zero = new Image();
      zero.src = "assets/zero.png"
      bomb = new Image();
      bomb.src = "assets/bomb.png"
      flag = new Image();
      flag.src = "assets/flag.png"

       //list of possible locations
      for (var i = 0; i < settings.rows; i++) {
       for (var j = 0; j < settings.cols; j++) {
          locations[locations.length] = [i,j];
        }; 
      }; 

      locations = shuffle(locations);

      for (var i = 0; i < numBombs; i++) {
        bombs[i] = locations[i];
      };
      drawCanvas();
    }

    var time = 0; 
    function timer(){
      setTimeout(function(){
        var timerDiv = document.getElementById("timer");
        time = time + 1;
        timerDiv.innerHTML = time + " s";
        timer();
      },1000);
    }

    function drawCanvas(){
      c.clearRect(0,0,400,400);
      for (var i = 0; i < settings.rows; i++) {
         for (var j = 0; j < settings.cols; j++) {
            var x = i*settings.width;
            var y = j*settings.height;
            var beenClicked = [0, false];

            for (var k = 0; k<clickedBoxes.length; k++) {
              if (i==clickedBoxes[k][0] && j==clickedBoxes[k][1]) {
                beenClicked = [k, true];
              }
            }

            if (beenClicked[1]==true){
              if (clickedBoxes[(beenClicked[0])][2] > 0){
                c.drawImage(zero, x, y);
              }
              else {
                c.drawImage(zero, x, y);
              }
            }
            else {
              var rightBeenClicked = [0, false];
              if (rightClickedBoxes.length > 0) {
                for (var k in rightClickedBoxes) {
                  if (i==rightClickedBoxes[k][0] && j==rightClickedBoxes[k][1]) {
                    rightBeenClicked = [k, true];
                  }
                }
              }
              if (rightBeenClicked[1]==true) {
                c.drawImage(flag, x, y);
              }
              else{
                c.drawImage(box, x, y);
              } 
            }
        }
      }

      for (i in clickedBoxes){
        if (clickedBoxes[i][2] > 0){
          c.font = "20px arial";
          c.fillText(clickedBoxes[i][2], clickedBoxes[i][0]*settings.width + 10 , clickedBoxes[i][1]*settings.height + 21)
        }
      }

    }

    var xPos;
    var yPos;
    var xTile;
    var yTile;

    window.onclick = function(e){
      xPos = e.pageX;
      yPos = e.pageY;

      if (Math.floor(xPos/settings.width) < settings.cols && Math.floor(yPos/settings.height) < settings.height){
        xTile = Math.floor(xPos/settings.width);
        yTile = Math.floor(yPos/settings.height);
      }

      var clickedBomb = false;
      for (var i = 0; i < bombs.length;i++){
        if (xTile==bombs[i][0] && yTile==bombs[i][1]){
          clickedBomb == true;
          revealBombs();
          window.alert("u lose!");

        }
      }

      if(clickedBomb==false && xPos < settings.rows*settings.width && yPos < settings.cols*settings.height){
          var totalClicked = numFlags + clickedBoxes.length;
          console.log(totalClicked);
          if (totalClicked>=99){
            win();
          }
        safeClick(xTile, yTile);
      }
    }

    var xRightClick;
    var yRightClick;
    var rightClickedBoxes = [];
    var inrightClickedBoxes = [0,false];
    var numFlags = 0;

    window.oncontextmenu = function(e){
      e.preventDefault();
      xPos = e.pageX;
      yPos = e.pageY;

      if (Math.floor(xPos/settings.width) < settings.cols && Math.floor(yPos/settings.height) < settings.height){
        xRightClick = Math.floor(xPos/settings.width);
        yRightClick = Math.floor(yPos/settings.height);
      }

      if (rightClickedBoxes.length > 0) {
        for (i in rightClickedBoxes) {
          if (rightClickedBoxes[i][0] == xRightClick && rightClickedBoxes[i][1] == yRightClick){
            inrightClickedBoxes = [i, true];
            break;
          }
          else{
            inrightClickedBoxes = [i, false];
          }
        }
      }
      else {
        inrightClickedBoxes[1] = false;
      }
      if (inrightClickedBoxes[1]==false){
        if (numFlags<numBombs){
          var n = rightClickedBoxes.length;
          rightClickedBoxes[n] = [];
          rightClickedBoxes[n][0] = xRightClick;
          rightClickedBoxes[n][1] = yRightClick;
          numFlags++;
          var totalClicked = numFlags + clickedBoxes.length;
          console.log(totalClicked);
          if (totalClicked>=99){
            win();
          }
        }  
      }
      else{
        rightClickedBoxes.splice(inrightClickedBoxes[0],1);
        numFlags--;
      }
      drawCanvas();
    }

    function win(){
      console.log("you win")
    }

    function lose(){
    }

    function newGame() {
      bombs = [];
      clickedBoxes = [];
      rightClickedBoxes = [];
      inrightClickedBoxes = [0,false]
      xPos;
      yPos;
      xTile;
      yTile;
      time = 0;
      init();
    }

    function  safeClick(x, y){
      var boxesToCheck = [
        [-1,-1],
        [0,-1],
        [1,-1],
        [-1,0],
        [1,0],
        [-1,1],
        [0,1],
        [1,1]
      ];

      var numBombsAround = 0;

      for (var i in boxesToCheck) { 
        for (var n = 0; n<bombs.length; n++) {
          if(checkBomb(n, x + boxesToCheck[i][0], y + boxesToCheck[i][1])==true){
            numBombsAround++;
          }
        }
      }
      clickedBoxes[clickedBoxes.length] = [x, y, numBombsAround];

      if (numBombsAround==0){
        for (var j in boxesToCheck) {
          if(x + boxesToCheck[j][0] >= 0 && x + boxesToCheck[j][0] < settings.rows && y + boxesToCheck[j][1] >= 0 && y + boxesToCheck[j][1] < settings.cols){
              var x1 = x + boxesToCheck[j][0];
              var y1 = y + boxesToCheck[j][1];

              var alreadyClicked = false;

              for (n in clickedBoxes) {
                if (clickedBoxes[n][0] == x1 && clickedBoxes[n][1] == y1) {
                  alreadyClicked = true;
                }
              }

              if (alreadyClicked == false) {
                safeClick(x1, y1);
              }
          }
        }
      }

      drawCanvas();
    }

    function checkBomb (i,x,y) {
      if (bombs[i][0]==x && bombs[i][1]==y){
        return true;
      }
      else {
        return false;
      }
    }

    function revealBombs(){
      for (i in bombs){
        c.drawImage(bomb, bombs[i][0]*settings.width, bombs[i][1]*settings.height);
      }
    }

    function shuffle(o){ //v1.0
      for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
    };

  </script>
</head>

<body>

  <div id="game">
    <canvas id="gCanvas" width="400" height="400">
    </canvas>
  </div>
   <div id="controls">
    <div id="timer">
      0 <span></span>
    </div>
    <div id="new" onclick="newGame();">
      New game!
    </div>
  </div>

</body>

</html>